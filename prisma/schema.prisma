generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum OrgUserRole {
  OWNER
  ADMIN
  MANAGER
  VIEWER
}

enum PaddockType {
  CAMPO_NATURAL
  PRADERA
  VERDEO
  OTRO
}

enum PaddockStatus {
  ACTIVE
  INACTIVE
}

enum HerdSpecies {
  BOVINO
  OVINO
}

enum HerdCategory {
  TERNEROS
  TERNERAS
  TERNEROS_DESTETADOS
  VAQUILLONAS
  VACAS
  TOROS
  NOVILLOS
  VIENTRES
  CORDEROS
  OVEJAS
  CARNEROS
}

enum HerdReproductiveStatus {
  VACIA
  PRENADA
  ENTORADA
  NA
}

enum HerdStatus {
  ACTIVE
  EGRESSED
  CLOSED
}

enum OperationType {
  MOVE
  VACCINATION
  BREEDING_START
  BREEDING_END
  WEANING
  BRANDING
  SHIPMENT_CREATED
  SHIPMENT_CONFIRMED
  SLAUGHTER_SHIPMENT_CREATED
  SLAUGHTER_SHIPMENT_CONFIRMED
  SLAUGHTER_SHIPMENT_LIQUIDATED
  MORTALITY
  PURCHASE
  SALE
}

enum Currency {
  UYU
  USD
}

enum SlaughterShipmentStatus {
  DRAFT
  CONFIRMED
  LIQUIDATED
  CANCELLED
}

enum UserStatus {
  ACTIVE
  INACTIVE
}

model Org {
  id        String   @id @default(uuid())
  name      String
  createdAt DateTime @default(now())

  users          OrgUser[]
  establishments Establishment[]
  consignors     Consignor[]
  slaughterhouses Slaughterhouse[]
  healthProducts HealthProduct[]
}

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  name         String
  passwordHash String
  status       UserStatus @default(ACTIVE)
  createdAt    DateTime @default(now())

  orgs OrgUser[]
}

model OrgUser {
  id        String   @id @default(uuid())
  orgId     String
  userId    String
  role      OrgUserRole
  createdAt DateTime @default(now())

  org  Org  @relation(fields: [orgId], references: [id])
  user User @relation(fields: [userId], references: [id])

  @@unique([orgId, userId])
}

model Establishment {
  id        String   @id @default(uuid())
  orgId     String
  name      String
  location  String?
  timezone  String
  createdAt DateTime @default(now())

  org      Org       @relation(fields: [orgId], references: [id])
  paddocks Paddock[]
  herds    Herd[]
  events   OperationEvent[]
  herdStates HerdState[]
  paddockOccupancies PaddockOccupancy[]
  shipments SlaughterShipment[]
}

model Paddock {
  id              String   @id @default(uuid())
  establishmentId String
  name            String
  areaHa          Float
  type            PaddockType
  status          PaddockStatus @default(ACTIVE)
  notes           String?
  createdAt       DateTime @default(now())

  establishment Establishment @relation(fields: [establishmentId], references: [id])
  herds         Herd[]
  occupancy     PaddockOccupancy?

  @@unique([establishmentId, name])
}

model Herd {
  id                String   @id @default(uuid())
  establishmentId   String
  code              String
  species           HerdSpecies
  category          HerdCategory
  qty               Int
  avgWeightKg       Float?
  reproductiveStatus HerdReproductiveStatus
  currentPaddockId  String?
  status            HerdStatus @default(ACTIVE)
  createdAt         DateTime @default(now())

  establishment Establishment @relation(fields: [establishmentId], references: [id])
  currentPaddock Paddock? @relation(fields: [currentPaddockId], references: [id])
  links          OperationLink[]
  herdState      HerdState?

  @@unique([establishmentId, code])
}

model OperationEvent {
  id              String   @id @default(uuid())
  establishmentId String
  type            OperationType
  occurredAt      DateTime
  createdBy       String
  payload         Json
  createdAt       DateTime @default(now())

  establishment Establishment @relation(fields: [establishmentId], references: [id])
  links         OperationLink[]
}

model OperationLink {
  id      String @id @default(uuid())
  eventId String
  herdId  String

  event OperationEvent @relation(fields: [eventId], references: [id])
  herd  Herd           @relation(fields: [herdId], references: [id])

  @@unique([eventId, herdId])
}

model HerdState {
  herdId            String   @id
  establishmentId   String
  currentPaddockId  String?
  qty               Int
  avgWeightKg       Float?
  category          HerdCategory
  species           HerdSpecies
  reproductiveStatus HerdReproductiveStatus
  status            HerdStatus
  lastEventAt       DateTime

  herd          Herd          @relation(fields: [herdId], references: [id])
  establishment Establishment @relation(fields: [establishmentId], references: [id])
}

model PaddockOccupancy {
  paddockId       String   @id
  establishmentId String
  herdIds         Json
  updatedAt       DateTime

  paddock       Paddock       @relation(fields: [paddockId], references: [id])
  establishment Establishment @relation(fields: [establishmentId], references: [id])
}

model HealthProduct {
  id                    String   @id @default(uuid())
  orgId                 String
  name                  String
  productType           String
  defaultWithdrawalDays Int?
  notes                 String?
  status                String
  createdAt             DateTime @default(now())

  org Org @relation(fields: [orgId], references: [id])
}

model Consignor {
  id        String   @id @default(uuid())
  orgId     String
  name      String
  taxId     String?
  phone     String?
  email     String?
  notes     String?
  status    String
  createdAt DateTime @default(now())

  org       Org                 @relation(fields: [orgId], references: [id])
  shipments SlaughterShipment[]
}

model Slaughterhouse {
  id        String   @id @default(uuid())
  orgId     String
  name      String
  location  String?
  taxId     String?
  notes     String?
  status    String
  createdAt DateTime @default(now())

  org       Org                 @relation(fields: [orgId], references: [id])
  shipments SlaughterShipment[]
}

model SlaughterShipment {
  id              String   @id @default(uuid())
  establishmentId String
  consignorId     String
  slaughterhouseId String
  occurredAt      DateTime
  currency        Currency
  docRef          String?
  transporterName String?
  truckPlate      String?
  status          SlaughterShipmentStatus @default(DRAFT)
  totalAmount     Decimal   @db.Decimal(14, 2)
  createdBy       String
  createdAt       DateTime @default(now())

  establishment Establishment @relation(fields: [establishmentId], references: [id])
  consignor     Consignor     @relation(fields: [consignorId], references: [id])
  slaughterhouse Slaughterhouse @relation(fields: [slaughterhouseId], references: [id])
  items         SlaughterShipmentItem[]
}

model SlaughterShipmentItem {
  id                  String   @id @default(uuid())
  slaughterShipmentId String
  category            HerdCategory
  herdId              String?
  qty                 Int
  unitPrice           Decimal @db.Decimal(14, 2)
  amount              Decimal @db.Decimal(14, 2)
  avgWeightKg         Float?
  notes               String?

  slaughterShipment SlaughterShipment @relation(fields: [slaughterShipmentId], references: [id])
}

model Shipment {
  id              String   @id @default(uuid())
  establishmentId String
  occurredAt      DateTime
  destination     String
  docRef          String?
  transporterName String?
  status          String
  createdBy       String
  createdAt       DateTime @default(now())

  establishment Establishment @relation(fields: [establishmentId], references: [id])
  items         ShipmentItem[]
}

model ShipmentItem {
  id          String   @id @default(uuid())
  shipmentId  String
  herdId      String?
  category    HerdCategory
  qty         Int
  avgWeightKg Float?
  notes       String?

  shipment Shipment @relation(fields: [shipmentId], references: [id])
}
